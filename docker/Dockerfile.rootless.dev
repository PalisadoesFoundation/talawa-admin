FROM node:24-slim
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ARG PORT=4321
ARG PNPM_VERSION=10.4.1
ARG WGET_VERSION=1.21.3-1+deb12u1
ARG CA_CERTIFICATES_VERSION=20230311+deb12u1
ENV PORT=${PORT}

# Build args are populated from host UID/GID by compose.
ARG USER_UID=1000
ARG USER_GID=1000

RUN set -eux; \
    current_uid="$(id -u node)"; \
    current_gid="$(id -g node)"; \
    if [ "${USER_GID}" != "${current_gid}" ]; then \
      if getent group "${USER_GID}" >/dev/null 2>&1; then \
        target_group="$(getent group "${USER_GID}" | cut -d: -f1)"; \
        usermod -g "${target_group}" node; \
      else \
        groupmod -g "${USER_GID}" node; \
      fi; \
    fi; \
    if [ "${USER_UID}" != "${current_uid}" ]; then \
      usermod -u "${USER_UID}" node; \
    fi

WORKDIR /usr/src/app

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
      wget=${WGET_VERSION} \
      ca-certificates=${CA_CERTIFICATES_VERSION} \
    && rm -rf /var/lib/apt/lists/*

RUN chown -R node:node /usr/src/app /home/node

RUN corepack enable

USER node
ENV HOME=/home/node
ENV XDG_CACHE_HOME=/home/node/.cache
ENV COREPACK_HOME=/home/node/.cache/corepack

RUN corepack prepare pnpm@${PNPM_VERSION} --activate

COPY --chown=node:node package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

COPY --chown=node:node . .

EXPOSE ${PORT}

CMD ["pnpm", "run", "serve"]
