#!/usr/bin/env bash
#
# =============================================================================
# Talawa Admin â€“ Git Pre-Commit Hook
# =============================================================================
#
# This is the main entry point for all pre-commit checks.
# It determines which files are staged, prepares temporary file lists,
# and delegates language-specific checks to dedicated scripts.
#
# Responsibilities:
# - Verify required tools are installed
# - Identify staged source files safely (null-delimited)
# - Run Node.js and Python pre-commit checks conditionally
# - Re-stage modified files after formatting
#
# Design Notes:
# - Uses temporary files instead of variables to safely handle filenames
# - Exits early if no files are staged to improve performance
# - Delegates logic to smaller scripts for maintainability
#
# =============================================================================

# If running under sh/dash (from Husky sourcing), re-execute with bash
if [ -z "$BASH_VERSION" ]; then
  exec bash "$0" "$@"
fi

set -euo pipefail

. .husky/scripts/staged-files.sh

.husky/scripts/check-tools.sh

STAGED_SRC_FILE=$(mktemp)
STAGED_ALL_FILE=$(mktemp)
trap 'rm -f "$STAGED_SRC_FILE" "$STAGED_ALL_FILE"; cleanup_staged_cache 2>/dev/null || true' EXIT

get_staged_files '^(src|scripts)/.*\.(ts|tsx|js|jsx)$' > "$STAGED_SRC_FILE"
get_staged_files > "$STAGED_ALL_FILE"

# Early exit if nothing staged
[ ! -s "$STAGED_ALL_FILE" ] && {
  echo "No staged files to check..."
  exit 0
}

# Design token validation (runs for any staged files so .css/.scss/.sass are checked even when no .ts/.tsx staged)
echo "Running design token validation..."
pnpm exec tsx scripts/validate-tokens.ts --staged --all || exit 1

if [ -s "$STAGED_SRC_FILE" ]; then
  .husky/scripts/precommit-node.sh "$STAGED_SRC_FILE"
fi

.husky/scripts/precommit-python.sh "$STAGED_SRC_FILE"

xargs -0 git add -- < "$STAGED_ALL_FILE"
