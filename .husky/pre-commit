#!/usr/bin/env sh
set -euo pipefail

.husky/scripts/check-tools.sh

STAGED_SRC_FILE=$(mktemp)
STAGED_ALL_FILE=$(mktemp)
trap 'rm -f "$STAGED_SRC_FILE" "$STAGED_ALL_FILE"' EXIT

git diff --cached -z --name-only --diff-filter=ACMRT \
  | grep -zE '^(src|scripts)/.*\.(ts|tsx|js|jsx)$' \
  > "$STAGED_SRC_FILE" || true

git diff --cached -z --name-only --diff-filter=ACMRT > "$STAGED_ALL_FILE"

# Early exit if nothing staged
[ ! -s "$STAGED_ALL_FILE" ] && {
  echo "No staged files to check..."
  exit 0
}

if [ -s "$STAGED_SRC_FILE" ]; then
  .husky/scripts/precommit-node.sh "$STAGED_SRC_FILE"
fi

.husky/scripts/precommit-python.sh "$STAGED_SRC_FILE"

xargs -0 < "$STAGED_ALL_FILE" git add --
