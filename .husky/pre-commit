#!/usr/bin/env bash
# =============================================================================
# Talawa Admin â€“ Git Pre-Commit Hook
# =============================================================================
set -euo pipefail

. .husky/scripts/staged-files.sh

.husky/scripts/check-tools.sh

STAGED_SRC_FILE=$(mktemp)
STAGED_ALL_FILE=$(mktemp)
trap 'rm -f "$STAGED_SRC_FILE" "$STAGED_ALL_FILE"; cleanup_staged_cache 2>/dev/null || true' EXIT

get_staged_files '^(src|scripts)/.*\.(ts|tsx|js|jsx)$' > "$STAGED_SRC_FILE"
get_staged_files > "$STAGED_ALL_FILE"

# Early exit if nothing staged
[ ! -s "$STAGED_ALL_FILE" ] && {
  echo "No staged files to check..."
  exit 0
}

if [ -s "$STAGED_SRC_FILE" ]; then
  .husky/scripts/precommit-node.sh "$STAGED_SRC_FILE"
fi

.husky/scripts/precommit-python.sh "$STAGED_SRC_FILE"

xargs -0 git add -- < "$STAGED_ALL_FILE"