<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /usr/share/nginx/html

    # Proxy GraphQL requests to the internal API container
    ProxyPass /graphql http://api:4000/graphql
    ProxyPassReverse /graphql http://api:4000/graphql

    # Handle WebSocket upgrades (FIXED REGEX)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule ^/graphql(.*)$           ws://api:4000/graphql$1 [P,L]

    # Serve React App (FIXED SECURITY)
    <Directory /usr/share/nginx/html>
        Options FollowSymLinks
        AllowOverride None
        Require all granted
        FallbackResource /index.html
    </Directory>
</VirtualHost>