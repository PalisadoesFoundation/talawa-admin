##############################################################################
##############################################################################
#
# Bash Unit Tests Workflow
# ========================
#
# This workflow runs unit tests for bash scripts in the repository,
# specifically for scripts/install/lib/common.sh using bats-core testing
# framework with kcov for coverage reporting.
#
##############################################################################
##############################################################################

name: Bash Unit Tests

on:
  pull_request:
    branches:
      - '**'
    paths:
      - 'scripts/install/**/*.sh'
      - 'tests/scripts/**/*.bats'
      - '.github/workflows/bash-tests.yml'
  push:
    branches:
      - develop
      - main
    paths:
      - 'scripts/install/**/*.sh'
      - 'tests/scripts/**/*.bats'
      - '.github/workflows/bash-tests.yml'

jobs:
  Bash-Unit-Tests:
    name: Run Bash Unit Tests with Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install bats-core
        run: |
          # Install bats-core using pnpm (per repo policy)
          sudo $(which pnpm) add -g bats

      - name: Install kcov for coverage
        run: |
          # Install kcov dependencies
          sudo apt-get update
          sudo apt-get install -y \
            binutils-dev \
            libcurl4-openssl-dev \
            zlib1g-dev \
            libdw-dev \
            libiberty-dev \
            cmake \
            gcc \
            g++ \
            python3

          # Build kcov from source for latest version
          cd /tmp
          git clone --depth 1 https://github.com/SimonKagstrom/kcov.git
          cd kcov
          mkdir build
          cd build
          cmake ..
          make
          sudo make install

      - name: Run bats tests
        run: |
          echo "Running bash unit tests for common.sh..."
          bats tests/scripts/install/common.bats --tap

      - name: Run tests with kcov coverage
        run: |
          echo "Running bash tests with coverage..."
          mkdir -p coverage/bash

          # Run kcov on the bats test file
          # kcov will trace all bash scripts sourced/executed during the tests
          kcov \
            --include-pattern=scripts/install/lib/common.sh \
            --exclude-pattern=tests/ \
            coverage/bash \
            bats tests/scripts/install/common.bats

      - name: Parse and display coverage for common.sh
        id: coverage
        run: |
          echo "=== Coverage Report for scripts/install/lib/common.sh ==="

          # Parse the kcov JSON output
          COVERAGE_FILE="coverage/bash/bats/coverage.json"

          if [ -f "$COVERAGE_FILE" ]; then
            # Extract coverage percentage using jq
            PERCENT=$(jq -r '.percent_covered' "$COVERAGE_FILE" 2>/dev/null || echo "N/A")
            LINES_COVERED=$(jq -r '.covered_lines' "$COVERAGE_FILE" 2>/dev/null || echo "N/A")
            TOTAL_LINES=$(jq -r '.total_lines' "$COVERAGE_FILE" 2>/dev/null || echo "N/A")

            echo ""
            echo "Coverage Summary:"
            echo "  File: scripts/install/lib/common.sh (Lines 1-361)"
            echo "  Lines Covered: $LINES_COVERED / $TOTAL_LINES"
            echo "  Coverage: ${PERCENT}%"
            echo ""

            # Set output for potential badge/artifact use
            echo "percent=$PERCENT" >> "$GITHUB_OUTPUT"
            echo "lines_covered=$LINES_COVERED" >> "$GITHUB_OUTPUT"
            echo "total_lines=$TOTAL_LINES" >> "$GITHUB_OUTPUT"
          else
            echo "Coverage file not found. Checking directory structure..."
            find coverage/bash -name "*.json" -type f
            echo "percent=0" >> "$GITHUB_OUTPUT"
          fi

          # Also show the cobertura XML if available
          COBERTURA_FILE="coverage/bash/bats/cobertura.xml"
          if [ -f "$COBERTURA_FILE" ]; then
            echo ""
            echo "Cobertura XML report generated at: $COBERTURA_FILE"
          fi

      - name: Generate coverage summary comment
        run: |
          echo "## Bash Script Coverage Report" > coverage/bash/summary.md
          echo "" >> coverage/bash/summary.md
          echo "| File | Lines Covered | Total Lines | Coverage |" >> coverage/bash/summary.md
          echo "|------|---------------|-------------|----------|" >> coverage/bash/summary.md
          echo "| \`scripts/install/lib/common.sh\` | ${{ steps.coverage.outputs.lines_covered }} | ${{ steps.coverage.outputs.total_lines }} | ${{ steps.coverage.outputs.percent }}% |" >> coverage/bash/summary.md
          echo "" >> coverage/bash/summary.md
          echo "Coverage report generated by [kcov](https://github.com/SimonKagstrom/kcov)" >> coverage/bash/summary.md

          cat coverage/bash/summary.md

      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: bash-coverage-report
          path: |
            coverage/bash/
          retention-days: 7

      - name: Upload coverage to Codecov (optional)
        if: ${{ vars.CODECOV_ENABLED == 'true' }}
        uses: codecov/codecov-action@v5
        with:
          files: coverage/bash/bats/cobertura.xml
          flags: bash
          name: bash-common-sh
          fail_ci_if_error: false
        continue-on-error: true
